if(!jQuery.browser.msie){hi5.IFrameShim=function(C,A,B){this.hide=function(){};this.show=function(){};this.updateProperties=function(){};};}hi5.unifiedAutocomplete=function(C,B,D){this.results=[];this.oldQuery="";this.oldQueryKeys="";this.isRunning=false;this.isPartialResult=false;this.haveResults=false;this.elem=null;this.searchBox=null;this.timeout=null;this.searchPending=false;this.selectedItemIndex=-1;this.selectedItem=null;this.categories=D;this.isFocused=false;this.resDiv=B;this.displayedResults=[];this.xhrSequence=0;this.searchBox=C;var A=this;this.searchBox.onkeyup=function(E){A.searchChanged(E);};this.searchBox.onblur=function(E){A.blurField(E);};this.searchBox.onfocus=function(E){A.focusField(E);};this.iframe=new hi5.IFrameShim(this.resDiv,true,"default");};hi5.unifiedAutocomplete.prototype={setSelection:function(C,D,B){if(document.selection){C.focus();var A=document.selection.createRange();A.moveStart("character",-C.value.length);A.moveStart("character",D);A.moveEnd("character",B);A.select();}else{if(C.selectionStart||C.selectionStart=="0"){C.selectionStart=D;C.selectionEnd=B;C.focus();}}},focusField:function(A){this.isFocused=true;this.drawDiv();},blurField:function(B){this.isFocused=false;var A=this;setTimeout(function(){A.drawDiv();},250);},getQuery:function(){var A=this.searchBox.value;if(A==null){return"";}else{return A.replace(/^\s+|\s+$/g,"").toLowerCase();}},updateTA:function(){var A=this.getQuery();if(A==""){if(this.timeout){clearTimeout(this.timeout);this.timeout=null;}this.isRunning=false;this.results=[];this.displayedResults=[];this.searchPending=false;this.selectedItemIndex=-1;this.selectedItem=null;}else{if(A!=this.oldQuery){if(this.haveResults&&(A.indexOf(this.oldQuery)==0)){if(this.isPartialResult){this.doSearch();}else{this.startTimeout();this.searchPending=false;}}else{this.doSearch();}}else{this.startTimeout();this.searchPending=false;}}this.drawDiv();this.oldQuery=A;},doSearch:function(){var sequence=++this.xhrSequence;this.searchPending=true;var uac=this;hi5.Ajax.get("/friend/processUnifiedSearch.do",{queryString:this.getQuery(),count:15,offset:0,handleLarge:false,ajax:true,categories:this.categories.join(",")},function(req){if(uac.xhrSequence>sequence){return ;}uac.searchPending=false;uac.selectedItemIndex=-1;uac.selectedItem=null;try{uac.results=eval(req.responseText);}catch(ex){}uac.drawDiv();if(uac.isRunning){uac.startTimeout();}},function(req){if(uac.xhrSequence>sequence){return ;}uac.searchPending=false;uac.selectedItemIndex=-1;uac.selectedItem=null;uac.results=[];uac.drawDiv();if(uac.isRunning){uac.startTimeout();}});},drawDiv:function(){var H="";this.haveResults=false;var O=0;this.displayedResults=[];var C=this.getQuery();if(C!=""&&this.results&&this.results.length>0&&this.isFocused){var F=hi5.getBounds(this.searchBox);var D=hi5.getBounds(this.resDiv.offsetParent);this.resDiv.style.width=(F.width-6)+"px";this.resDiv.style.left=F.left-D.left+"px";this.resDiv.style.top=(F.top-D.top+F.height-1)+"px";this.isPartialResult=false;H+="<ul id='results-contents'>";for(var N=0;N<this.results.length;N++){var E=this.results[N];this.isPartialResult|=E.isPartialResult;this.haveResults|=true;var B="";for(var L=0;L<E.results.length;L++){var P=E.results[L];var R=P.caption;if(R.toLowerCase().indexOf(C)>=0){var Q=R.toLowerCase().indexOf(C);var K=Q+C.length;var M=R.substr(0,Q)+"<span class='highlighted-result'>"+R.substr(Q,C.length)+"</span>"+R.substr(K,R.length-K);var I="<li class='search-item";if(this.selectedItemIndex==O){I+=" selected-item";this.selectedItem=P;}I+="'>";var G='<a class="item-link" href="'+P.url+'">';var J="<img class='item-image' src='_noexist'/>";if(P.image&&P.image!=""){J='<img class="item-image" src="'+P.image+'"/>';}B+=I+G+J+M+"</a></li>\n";this.displayedResults[O++]=P;}}if(B.length>0){if(this.categories.length>1||this.categories[0]=="all"){B="<li class='category-item'>\n"+E.caption+"\n"+"<ul class='category-item-list'>"+B+"</ul>\n";}H+=B;}}H+="</ul>";var A=O>0;hi5.setVisibility(this.resDiv,A);if(A){this.iframe.show();}else{this.iframe.hide();}}else{H+="[hidden div]";hi5.setVisibility(this.resDiv,false);this.iframe.hide();}this.resDiv.innerHTML=H;},startTimeout:function(){if(this.timeout){clearTimeout(this.timeout);}var A=this;this.timeout=setTimeout(function(){A.updateTA();},500);this.isRunning=true;},haltEvent:function(A){if(hi5.isFunction(A.preventDefault)){A.preventDefault();}if(hi5.isFunction(A.stopPropagation)){A.stopPropagation();}if(hi5.isFunction(A.cancelBubble)){A.cancelBubble();}},searchChanged:function(E){var D=true;var A=(window.event)?window.event:E;var C=A.keyCode;switch(C){case 38:if(this.selectedItemIndex>=0){this.selectedItemIndex--;this.selectedItem=this.displayedResults[this.selectedItemIndex];}else{this.selectedItemIndex=-1;this.selectedItem=null;}this.haltEvent(A);D=false;break;case 40:if(this.selectedItemIndex<this.displayedResults.length-1){this.selectedItemIndex++;this.selectedItem=this.displayedResults[this.selectedItemIndex];}this.haltEvent(A);D=false;break;case 13:if(this.selectedItem){window.location=this.selectedItem.url;this.haltEvent(A);return false;}break;case 39:if(this.selectedItem){this.searchBox.value=this.selectedItem.caption;this.selectedItem=null;this.selectedItemIndex=-1;this.haltEvent(A);}D=false;break;case 27:this.searchBox.blur();D=false;this.haltEvent(A);break;default:var B=this.getQuery();if(B){if(B!=this.oldQueryKeys){this.searchPending=true;}if(this.oldQueryKeys.length<3&&B.length>=3){this.updateTA();this.startTimeout();}else{if(!this.isRunning){this.startTimeout();}}}else{}this.oldQueryKeys=B;break;}this.drawDiv();return D;}};